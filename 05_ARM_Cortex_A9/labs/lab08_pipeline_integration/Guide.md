# Lab 8: 完整流水线集成

## 📋 实验概述

| 项目 | 内容 |
|------|------|
| **实验名称** | ARM Cortex-A9 完整流水线集成 |
| **预计时长** | 12-15 小时 |
| **难度等级** | ⭐⭐⭐⭐⭐ |
| **前置实验** | Lab 1-7 |

## 🎯 实验目标

1. 将所有模块集成为完整处理器
2. 验证流水线正确运行
3. 运行简单程序测试
4. 性能分析与优化

---

## 📚 理论背景

### 完整处理器架构

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         ARM Cortex-A9 Core                                 │
│                                                                            │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌───────┐│
│  │   IF     │───▶│   ID     │───▶│   EX     │───▶│   MEM    │───▶│  WB   ││
│  │ Fetch    │    │ Decode   │    │ Execute  │    │ Memory   │    │Write  ││
│  └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └───┬───┘│
│       │               │               │               │              │     │
│       │               ▼               ▼               ▼              │     │
│       │          ┌─────────┐    ┌──────────┐    ┌─────────┐         │     │
│       │          │Register │    │   ALU    │    │ D-Cache │         │     │
│       │          │  File   │    │ Shifter  │    └─────────┘         │     │
│       │          └─────────┘    │ Mul/Div  │                        │     │
│       │                         └──────────┘                        │     │
│       │                                                             │     │
│       │    ┌──────────────────────────────────────────────────┐    │     │
│       │    │              Hazard Unit                          │    │     │
│       │    │  ┌────────────────┐  ┌────────────────┐          │    │     │
│       │    │  │ Forwarding     │  │ Stall/Flush    │          │    │     │
│       │    │  └────────────────┘  └────────────────┘          │    │     │
│       │    └──────────────────────────────────────────────────┘    │     │
│       │                                                             │     │
│       │                                                             │     │
│  ┌────▼─────┐                                                       │     │
│  │ I-Cache  │◀──────────────────────────────────────────────────────┘     │
│  └──────────┘           Branch Target                                     │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
         │                              │
         ▼                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            AXI Interconnect                                  │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Main Memory                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 模块连接关系

```verilog
// 主要数据路径
IF → IF/ID → ID → ID/EX → EX → EX/MEM → MEM → MEM/WB → WB

// 前递路径
EX/MEM.Result → EX (Forward)
MEM/WB.Result → EX (Forward)

// 控制路径
Hazard Unit → IF (Stall/Flush)
Hazard Unit → ID (Stall/Flush)
Hazard Unit → EX (Flush)

// 分支路径
EX.Branch_Target → IF.PC
EX.Branch_Taken → IF/ID (Flush)
```

### 集成测试程序

```asm
@ 简单加法测试
    MOV R0, #1          @ R0 = 1
    MOV R1, #2          @ R1 = 2
    ADD R2, R0, R1      @ R2 = R0 + R1 = 3
    
@ 数据冒险测试 (前递)
    MOV R3, #10         @ R3 = 10
    ADD R4, R3, #5      @ R4 = R3 + 5 = 15 (需前递)
    SUB R5, R4, R3      @ R5 = R4 - R3 = 5 (需前递)
    
@ Load-Use 冒险测试
    LDR R6, [R0]        @ R6 = Mem[R0]
    ADD R7, R6, #1      @ R7 = R6 + 1 (需暂停)
    
@ 分支测试
    CMP R2, #3          @ 比较 R2 和 3
    BEQ equal           @ 如果相等，跳转
    MOV R8, #0          @ 不应执行
equal:
    MOV R8, #1          @ R8 = 1
    
@ 循环测试
    MOV R9, #5          @ R9 = 5 (循环计数)
loop:
    SUB R9, R9, #1      @ R9 = R9 - 1
    CMP R9, #0          @ 比较 R9 和 0
    BNE loop            @ 如果不为 0，继续循环
```

---

## 📝 代码实现

详见 `src/arm_core.v`

---

## ✅ 检查点

- [ ] 所有模块正确连接
- [ ] 基本指令执行正确
- [ ] 前递正确工作
- [ ] 暂停/冲刷正确
- [ ] 分支执行正确
- [ ] 存储器访问正确

---

## 🔗 下一步

完成本实验后，继续 **Lab 9: 系统验证**。
