# Lab 7: å­˜å‚¨å™¨æ¥å£è®¾è®¡

## ğŸ“‹ å®éªŒæ¦‚è¿°

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å®éªŒåç§°** | Memory Unit ä¸ AXI æ€»çº¿æ¥å£è®¾è®¡ |
| **é¢„è®¡æ—¶é•¿** | 8-10 å°æ—¶ |
| **éš¾åº¦ç­‰çº§** | â­â­â­â­â­ |
| **å‰ç½®å®éªŒ** | Lab 6 |

## ğŸ¯ å®éªŒç›®æ ‡

1. ç†è§£ Memory Unit (MEM Stage) è®¾è®¡åŸç†
2. å®ç° LDR/STR æŒ‡ä»¤çš„å­˜å‚¨å™¨è®¿é—®é€»è¾‘
3. ç†è§£ AXI4 åè®®åŸºç¡€
4. å®ç°ç®€åŒ–çš„ AXI ä¸»æ¥å£
5. è¿æ¥ Cache ä¸å¤–éƒ¨å­˜å‚¨å™¨
6. å®ç° Burst ä¼ è¾“

---

## ğŸ“¦ å…³é”®æ¨¡å—ï¼šMemory Unit

### æ¨¡å—æ¦‚è¿°

`memory_unit.v` æ˜¯è®¿å­˜é˜¶æ®µ (MEM Stage) çš„æ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£å¤„ç† ARM æ¶æ„ä¸­çš„ LDR (Load) å’Œ STR (Store) æŒ‡ä»¤ã€‚

### åŠŸèƒ½ç‰¹æ€§

1. **æ•°æ®è®¿é—®ç±»å‹æ”¯æŒ**
   - Word (32-bit): LDR/STR
   - Halfword (16-bit): LDRH/STRH
   - Byte (8-bit): LDRB/STRB

2. **ç¬¦å·æ‰©å±•**
   - æ— ç¬¦å·åŠ è½½: LDRB, LDRH
   - æœ‰ç¬¦å·åŠ è½½: LDRSB, LDRSH

3. **å­—èŠ‚ä½¿èƒ½ç”Ÿæˆ**
   - æ ¹æ®åœ°å€åç§»å’Œè®¿é—®å¤§å°ç”Ÿæˆæ­£ç¡®çš„å­—èŠ‚é€‰é€šä¿¡å·

4. **æµæ°´çº¿æ§åˆ¶**
   - äº§ç”Ÿ mem_stall ä¿¡å·ç”¨äºç­‰å¾…å­˜å‚¨å™¨å“åº”

### æ¥å£å®šä¹‰

```verilog
module memory_unit #(
    parameter DATA_WIDTH = 32,
    parameter ADDR_WIDTH = 32
)(
    // æ—¶é’Ÿå¤ä½
    input  wire                     clk,
    input  wire                     rst_n,
    
    // æ§åˆ¶ä¿¡å·
    input  wire                     mem_read,       // è¯»ä½¿èƒ½ (LDR)
    input  wire                     mem_write,      // å†™ä½¿èƒ½ (STR)
    input  wire [1:0]               mem_size,       // è®¿é—®å¤§å°: 00=Byte, 01=Half, 10=Word
    input  wire                     mem_signed,     // æœ‰ç¬¦å·åŠ è½½
    
    // æ•°æ®æ¥å£
    input  wire [ADDR_WIDTH-1:0]    addr,           // è®¿é—®åœ°å€ (æ¥è‡ª ALU ç»“æœ)
    input  wire [DATA_WIDTH-1:0]    write_data,     // å†™å…¥æ•°æ® (æ¥è‡ª Rs)
    output reg  [DATA_WIDTH-1:0]    read_data,      // è¯»å–æ•°æ® (é€å¾€ WB)
    output wire                     mem_stall,      // å­˜å‚¨å™¨æš‚åœä¿¡å·
    
    // æ•°æ®å­˜å‚¨å™¨æ¥å£
    output wire [ADDR_WIDTH-1:0]    dmem_addr,
    output reg  [DATA_WIDTH-1:0]    dmem_wr_data,
    output wire                     dmem_wr_en,
    output wire                     dmem_rd_en,
    output reg  [3:0]               dmem_byte_en,   // å­—èŠ‚ä½¿èƒ½
    input  wire [DATA_WIDTH-1:0]    dmem_rd_data,
    input  wire                     dmem_rd_valid
);
```

### å­—èŠ‚ä½¿èƒ½ç”Ÿæˆé€»è¾‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å­—èŠ‚ä½¿èƒ½ (Byte Enable) ç”Ÿæˆ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   mem_size    â”‚  addr[1:0]    â”‚         dmem_byte_en              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   2'b10 Word  â”‚     xx        â”‚         4'b1111                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   2'b01 Half  â”‚     00        â”‚         4'b0011                   â”‚
â”‚   2'b01 Half  â”‚     10        â”‚         4'b1100                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   2'b00 Byte  â”‚     00        â”‚         4'b0001                   â”‚
â”‚   2'b00 Byte  â”‚     01        â”‚         4'b0010                   â”‚
â”‚   2'b00 Byte  â”‚     10        â”‚         4'b0100                   â”‚
â”‚   2'b00 Byte  â”‚     11        â”‚         4'b1000                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¬¦å·æ‰©å±•é€»è¾‘

```verilog
// å­—èŠ‚åŠ è½½
byte_data = dmem_rd_data[7:0];  // æ ¹æ®åœ°å€åç§»é€‰æ‹©
read_data = mem_signed ? {{24{byte_data[7]}}, byte_data} 
                       : {24'b0, byte_data};

// åŠå­—åŠ è½½
half_data = dmem_rd_data[15:0]; // æ ¹æ®åœ°å€åç§»é€‰æ‹©
read_data = mem_signed ? {{16{half_data[15]}}, half_data}
                       : {16'b0, half_data};
```

### ä¸ cortex_a9_top.v çš„è¿æ¥

```verilog
memory_unit #(
    .DATA_WIDTH(DATA_WIDTH),
    .ADDR_WIDTH(ADDR_WIDTH)
) u_memory_unit (
    .clk            (clk),
    .rst_n          (rst_n),
    // æ§åˆ¶ä¿¡å· (æ¥è‡ª EX/MEM æµæ°´çº¿å¯„å­˜å™¨)
    .mem_read       (mem_mem_read),
    .mem_write      (mem_mem_write),
    .mem_size       (mem_mem_size),
    .mem_signed     (mem_mem_signed),
    // æ•°æ® (æ¥è‡ª EX/MEM æµæ°´çº¿å¯„å­˜å™¨)
    .addr           (mem_alu_result),
    .write_data     (mem_write_data),
    .read_data      (mem_read_data),    // é€å¾€ MEM/WB å¯„å­˜å™¨
    .mem_stall      (mem_stall),
    // å¤–éƒ¨å­˜å‚¨å™¨æ¥å£
    .dmem_addr      (dmem_addr),
    .dmem_wr_data   (dmem_wr_data),
    .dmem_wr_en     (dmem_wr_en),
    .dmem_rd_en     (dmem_rd_en),
    .dmem_byte_en   (dmem_byte_en),
    .dmem_rd_data   (dmem_rd_data),
    .dmem_rd_valid  (dmem_rd_valid)
);
```

---

## ğŸ“š ç†è®ºèƒŒæ™¯

### AXI4 åè®®æ¦‚è¿°

AXI (Advanced eXtensible Interface) æ˜¯ AMBA 4.0 è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºé«˜æ€§èƒ½å¤„ç†å™¨ä¸å¤–è®¾é€šä¿¡ã€‚

#### äº”ä¸ªç‹¬ç«‹é€šé“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       AXI Master                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Write Addr â”‚ â”‚ Write Data â”‚ â”‚ Write Resp â”‚ â”‚Read â”‚ â”‚Read â”‚ â”‚
â”‚  â”‚  Channel   â”‚ â”‚  Channel   â”‚ â”‚  Channel   â”‚ â”‚Addr â”‚ â”‚Data â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â–²â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚           â”‚       â”‚
         â–¼              â–¼              â”‚           â–¼       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”´â”€â”€â” â”‚
â”‚  â”‚ Write Addr â”‚ â”‚ Write Data â”‚ â”‚ Write Resp â”‚ â”‚Read â”‚ â”‚Read â”‚ â”‚
â”‚  â”‚  Channel   â”‚ â”‚  Channel   â”‚ â”‚  Channel   â”‚ â”‚Addr â”‚ â”‚Data â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       AXI Slave                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¡æ‰‹åè®®

```
        â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”
CLK â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€

              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
VALID â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
READY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€

                          â—€â”€ ä¼ è¾“ â”€â–¶
                        (VALID && READY)
```

### AXI Burst ç±»å‹

| ç±»å‹ | AWBURST/ARBURST | æè¿° |
|------|-----------------|------|
| FIXED | 2'b00 | åœ°å€å›ºå®šï¼Œç”¨äº FIFO è®¿é—® |
| INCR  | 2'b01 | åœ°å€é€’å¢ï¼Œæœ€å¸¸ç”¨ |
| WRAP  | 2'b10 | å›ç»•ï¼Œç”¨äº Cache Line Fill |

### Burst é•¿åº¦ä¸å¤§å°

```verilog
// Cache Line Fill ç¤ºä¾‹ (32å­—èŠ‚ = 8 Ã— 4å­—èŠ‚)
AWLEN  = 8'h07;   // 8 æ¬¡ä¼ è¾“ (0-based)
AWSIZE = 3'b010;  // 4 å­—èŠ‚ (2^2)
AWBURST = 2'b01;  // INCR
```

---

## ğŸ”— Memory Unit ä¸ AXI Master çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Pipeline                               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   EX    â”‚â”€â”€â”€â–¶â”‚ Memory Unit  â”‚â”€â”€â”€â–¶â”‚    D-Cache/AXI      â”‚    â”‚
â”‚  â”‚  Stage  â”‚    â”‚ (å­—èŠ‚ä½¿èƒ½,   â”‚    â”‚    Master           â”‚    â”‚
â”‚  â”‚         â”‚    â”‚  ç¬¦å·æ‰©å±•)   â”‚    â”‚ (Burstä¼ è¾“,åè®®è½¬æ¢)â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â”‚                       â”‚                â”‚
â”‚                        â–¼                       â–¼                â”‚
â”‚                 ç®€å•å­˜å‚¨å™¨æ¥å£            AXI4 æ€»çº¿æ¥å£          â”‚
â”‚               (dmem_addr, etc.)      (AWADDR, WDATA, etc.)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Memory Unit**: å¤„ç†æŒ‡ä»¤çº§åˆ«çš„å­˜å‚¨å™¨è®¿é—®è¯­ä¹‰ï¼ˆå¤§å°ã€å¯¹é½ã€ç¬¦å·æ‰©å±•ï¼‰
- **AXI Master**: å¤„ç†æ€»çº¿åè®®çº§åˆ«çš„æ•°æ®ä¼ è¾“ï¼ˆæ¡æ‰‹ã€Burstã€å“åº”ï¼‰

---

## ğŸ“ ä»£ç å®ç°

è¯¦è§ï¼š
- `src/memory_unit.v` - MEM é˜¶æ®µæ ¸å¿ƒé€»è¾‘
- `src/axi_master.v` - AXI æ€»çº¿æ¥å£

---

## âœ… æ£€æŸ¥ç‚¹

- [ ] Memory Unit å­—èŠ‚ä½¿èƒ½ç”Ÿæˆæ­£ç¡®
- [ ] Memory Unit ç¬¦å·æ‰©å±•æ­£ç¡®
- [ ] AXI è¯»é€šé“æ­£ç¡®æ¡æ‰‹
- [ ] AXI å†™é€šé“æ­£ç¡®æ¡æ‰‹
- [ ] Burst ä¼ è¾“æ­£ç¡®
- [ ] ä¸ Cache æ­£ç¡®è¿æ¥
- [ ] æ— åè®®è¿è§„

---

## ğŸ”— ä¸‹ä¸€æ­¥

å®Œæˆæœ¬å®éªŒåï¼Œç»§ç»­ **Lab 8: æµæ°´çº¿é›†æˆ**ã€‚
