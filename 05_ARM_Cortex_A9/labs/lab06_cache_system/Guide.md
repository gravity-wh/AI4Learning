# Lab 6: ç¼“å­˜ç³»ç»Ÿè®¾è®¡

## ğŸ“‹ å®éªŒæ¦‚è¿°

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å®éªŒåç§°** | æŒ‡ä»¤ç¼“å­˜ä¸æ•°æ®ç¼“å­˜è®¾è®¡ |
| **é¢„è®¡æ—¶é•¿** | 10-12 å°æ—¶ |
| **éš¾åº¦ç­‰çº§** | â­â­â­â­â­ |
| **å‰ç½®å®éªŒ** | Lab 1-5 |

## ğŸ¯ å®éªŒç›®æ ‡

1. è®¾è®¡ç›´æ¥æ˜ å°„/ç»„ç›¸è” I-Cache
2. è®¾è®¡å†™å›å¼ D-Cache
3. å®ç° Cache æ§åˆ¶çŠ¶æ€æœº
4. ç†è§£ç¼“å­˜ä¸€è‡´æ€§åŸºç¡€

---

## ğŸ“š ç†è®ºèƒŒæ™¯

### Cache åŸºæœ¬ç»“æ„

```
åœ°å€åˆ†è§£ (32ä½åœ°å€ï¼Œ256å­—èŠ‚ Cacheï¼Œ4å­— Cache Line):

    31           12 11        4 3     2 1   0
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
   â”‚     Tag       â”‚   Index  â”‚ Offsetâ”‚Byte â”‚
   â”‚   (20 bits)   â”‚ (8 bits) â”‚(2bits)â”‚(2b) â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

Cache ç»“æ„:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Valid  â”‚  Tag   â”‚          Data (Cache Line)         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚   1    â”‚   20   â”‚  Word0  â”‚  Word1  â”‚  Word2  â”‚ Word3â”‚
   â”‚  bit   â”‚  bits  â”‚  32bits â”‚  32bits â”‚  32bits â”‚32bitsâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ç›¸è” Cache

```
4-Way Set Associative Cache:

Index â”€â”¬â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚  Way 0  â”‚  Way 1  â”‚  Way 2  â”‚  Way 3       â”‚
       â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”œâ”€â–¶ â”‚ Vâ”‚Tagâ”‚D â”‚ Vâ”‚Tagâ”‚D â”‚ Vâ”‚Tagâ”‚D â”‚ Vâ”‚Tagâ”‚D      â”‚ Set 0
       â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”œâ”€â–¶ â”‚ Vâ”‚Tagâ”‚D â”‚ Vâ”‚Tagâ”‚D â”‚ Vâ”‚Tagâ”‚D â”‚ Vâ”‚Tagâ”‚D      â”‚ Set 1
       â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       ...

Tag Compare:
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   Req Tag â”€â”€â”€â–¶ â”‚   ==    â”‚â”€â–¶ Hit Way 0
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   Tag0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†™ç­–ç•¥

#### 1. å†™ç›´è¾¾ (Write-Through)
```
å†™å‘½ä¸­:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Cache  â”‚â—€â”€â”€ å†™å…¥
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ åŒæ—¶å†™å…¥
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Memory  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
ä¼˜ç‚¹: ç®€å•ï¼Œç¼“å­˜ä¸€è‡´æ€§æ˜“ç»´æŠ¤
ç¼ºç‚¹: å†™å¸¦å®½éœ€æ±‚é«˜
```

#### 2. å†™å› (Write-Back)
```
å†™å‘½ä¸­:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Cache  â”‚â—€â”€â”€ å†™å…¥ï¼Œè®¾ç½® Dirty ä½
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         
æ›¿æ¢æ—¶ (è‹¥ Dirty):
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Cache  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ å†™å›
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Memory  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹: å‡å°‘å†…å­˜å†™æ“ä½œ
ç¼ºç‚¹: æ›¿æ¢æ—¶å»¶è¿Ÿé«˜ï¼Œä¸€è‡´æ€§å¤æ‚
```

### æ›¿æ¢ç­–ç•¥

```verilog
// LRU (Least Recently Used) - 2è·¯ç¤ºä¾‹
always @(posedge clk) begin
    if (hit_way0)
        lru_bit[index] <= 1'b1;  // Way0 æœ€è¿‘ä½¿ç”¨ï¼Œä¸‹æ¬¡æ›¿æ¢ Way1
    else if (hit_way1)
        lru_bit[index] <= 1'b0;  // Way1 æœ€è¿‘ä½¿ç”¨ï¼Œä¸‹æ¬¡æ›¿æ¢ Way0
end

wire replace_way = lru_bit[index];  // 0=æ›¿æ¢Way0, 1=æ›¿æ¢Way1
```

### Cache çŠ¶æ€æœº

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  IDLE   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â”‚
        â”‚                â”‚ è¯·æ±‚           â”‚ å®Œæˆ
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚     â–¼                     â–¼     â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”    Miss    â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚ â”‚Compareâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚Allocateâ”‚  â”‚
        â”‚ â”‚ Tag   â”‚            â”‚       â”‚  â”‚
        â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”˜            â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â”‚
        â”‚     â”‚ Hit                â”‚      â”‚
        â”‚     â–¼                    â–¼      â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â””â”€â”‚ Done  â”‚            â”‚ Fill  â”‚â”€â”€â”˜
          â””â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ä»£ç å®ç°

è¯¦è§ `src/icache.v` å’Œ `src/dcache.v`

---

## âœ… æ£€æŸ¥ç‚¹

- [ ] Cache å‘½ä¸­æ­£ç¡®
- [ ] Cache ç¼ºå¤±å¤„ç†æ­£ç¡®
- [ ] å†™ç­–ç•¥æ­£ç¡®å®ç°
- [ ] LRU æ›¿æ¢æ­£ç¡®
- [ ] çŠ¶æ€æœºæ— æ­»é”

---

## ğŸ”— ä¸‹ä¸€æ­¥

å®Œæˆæœ¬å®éªŒåï¼Œç»§ç»­ **Lab 7: å­˜å‚¨å™¨æ¥å£è®¾è®¡**ã€‚
