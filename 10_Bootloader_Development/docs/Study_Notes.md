# Bootloader 开发（系统引导）学习笔记

## 模块 1：Bootloader 基础与 RISC-V 架构

### 核心概念总结
- **Bootloader**：系统上电后执行的第一段代码，负责初始化硬件并加载操作系统内核
- **RISC-V 特权级**：
  - M 模式（Machine Mode）：最高特权级，用于硬件管理和中断处理
  - S 模式（Supervisor Mode）：操作系统内核运行模式
  - U 模式（User Mode）：应用程序运行模式
- **RISC-V 寄存器**：32/64 个通用寄存器（x0-x31）、程序计数器（pc）、控制状态寄存器（CSR）
- **《RISC-V Boot Flow Specification》**：定义了 RISC-V 系统的标准启动流程

### 关键难点记录
- 理解不同特权级之间的资源访问权限
- 掌握 RISC-V 控制状态寄存器的配置方法
- 区分 Bootloader 与固件、BIOS 的概念差异

### 参考资料
- 《RISC-V 架构手册》卷 I：用户级 ISA
- 《RISC-V Boot Flow Specification》官方文档

## 模块 2：Bootloader 工作流程

### 核心概念总结
- **系统上电流程**：Reset Vector → ROM Code → Bootloader → OS Kernel
- **硬件初始化顺序**：时钟 → UART → GPIO → 内存 → 其他外设
- **内存初始化**：包括 DDR 控制器配置、内存时序参数设置、内存测试
- **内核加载**：从存储设备（SD 卡、Flash）或串口读取内核镜像到内存
- **内核启动**：设置启动参数，跳转到内核入口地址执行

### 关键难点记录
- 不同硬件平台的初始化顺序差异
- DDR 内存初始化的时序参数配置
- 内核镜像的格式验证与加载位置计算

### 参考资料
- U-Boot 源码分析（arch/riscv/cpu）
- RISC-V 平台内存控制器文档

## 模块 3：RISC-V 特权级切换

### 核心概念总结
- **M 模式到 S 模式切换步骤**：
  1. 配置 MSTATUS 寄存器，设置 SPP（Supervisor Previous Privilege）
  2. 配置 MEPC（Machine Exception Program Counter）为内核入口地址
  3. 配置 PMP（Physical Memory Protection）区域
  4. 执行 MRET 指令返回到 S 模式
- **OpenSBI**：RISC-V 的 Supervisor Binary Interface，负责特权级切换和基本服务
- **控制状态寄存器（CSR）**：mstatus、mepc、mtvec、mideleg、medeleg 等

### 关键难点记录
- 特权级切换时的上下文保存与恢复
- OpenSBI 的集成与配置方法
- PMP 区域的合理配置以确保系统安全

### 参考资料
- OpenSBI 官方文档
- RISC-V 特权架构手册

## 模块 4：设备树（Device Tree）基础

### 核心概念总结
- **设备树**：一种描述硬件资源的数据结构，用于实现内核与硬件的解耦
- **DTS**：设备树源文件，采用文本格式描述硬件
- **DTB**：设备树二进制文件，由 DTS 编译生成，供内核解析
- **设备树节点**：表示硬件设备，包含兼容属性、地址范围、中断信息等
- **Bootloader 角色**：传递 DTB 给内核，可能修改部分硬件配置

### 关键难点记录
- 设备树语法与结构的理解
- 如何为自定义硬件编写设备树
- Bootloader 与内核之间的设备树传递机制

### 参考资料
- Device Tree Specification 官方文档
- Linux 内核设备树绑定文档

## 模块 5：Bootloader 高级特性

### 核心概念总结
- **U-Boot 架构**：模块化设计，支持多种架构和设备
- **镜像加载方式**：
  - SD 卡：使用 MMC 控制器读取
  - 网络：通过 TFTP、NFS 协议下载
  - 串口：通过 XMODEM、YMODEM 协议传输
- **启动参数**：通过设备树或 ATAGs 传递给内核
- **安全启动**：实现镜像签名验证，防止未授权内核运行

### 关键难点记录
- U-Boot 命令系统的工作原理
- 不同存储设备的驱动实现
- 安全启动机制的设计与实现

### 参考资料
- U-Boot 开发者手册
- Linux 内核启动参数文档

## 模块 6：Bootloader 项目实践

### 核心概念总结
- **Bootloader 架构设计**：阶段划分（Stage 1/Stage 2）、内存布局
- **硬件抽象层**：封装不同硬件平台的差异
- **内核镜像格式**：ELF、uImage、zImage 等格式的处理
- **系统测试**：功能测试、性能测试、稳定性测试

### 关键难点记录
- 为自研 RISC 软核定制 Bootloader
- 处理不同硬件平台的兼容性
- 优化 Bootloader 的启动速度

### 参考资料
- 自研 RISC 软核技术文档
- U-Boot 移植指南

## 实验记录

### 实验 1：RISC-V Bootloader 基础与开发环境搭建
- **实验目标**：搭建 RISC-V 交叉编译环境，分析 U-Boot 源码结构
- **实验步骤**：
  1. 安装 GCC/RISC-V 交叉编译工具链
  2. 安装 QEMU RISC-V 模拟器
  3. 下载并分析 U-Boot 源码
  4. 编译 U-Boot 并在 QEMU 中运行
- **实验结果**：
  - 成功搭建开发环境
  - 理解 U-Boot 的目录结构和编译流程
- **问题与解决**：
  - 工具链版本兼容性问题：通过指定正确的工具链版本解决

### 实验 2：硬件初始化与特权级切换
- **实验目标**：实现基本硬件初始化与 M 模式到 S 模式的切换
- **实验步骤**：
  1. 编写 UART 初始化代码
  2. 实现 M 模式到 S 模式的切换逻辑
  3. 集成 OpenSBI
  4. 测试特权级切换功能
- **实验结果**：
  - 成功初始化 UART 并实现串口输出
  - 完成 M 模式到 S 模式的切换
- **问题与解决**：
  - CSR 寄存器配置错误：参考 RISC-V 架构手册修正配置

### 实验 3：内核加载与设备树处理
- **实验目标**：实现内核镜像加载与设备树传递
- **实验步骤**：
  1. 编写串口接收内核镜像的代码
  2. 解析设备树文件
  3. 将内核镜像和设备树加载到指定内存位置
- **实验结果**：
  - 成功从串口接收内核镜像
  - 正确解析并传递设备树给内核
- **问题与解决**：
  - 内存对齐问题：确保内核加载地址满足对齐要求

### 实验 4：完整 Bootloader 实现与测试
- **实验目标**：整合所有模块，实现完整的 Bootloader
- **实验步骤**：
  1. 整合硬件初始化、特权级切换、内核加载等模块
  2. 在自研 RISC 软核上测试 Bootloader
  3. 验证内核启动功能
  4. 优化 Bootloader 性能
- **实验结果**：
  - 成功实现完整的 Bootloader
  - 内核能够正常启动并运行
- **问题与解决**：
  - 启动参数传递错误：修正设备树中的启动参数配置

## 学习进度跟踪

| 模块 | 学习状态 | 完成时间 | 掌握程度 |
|------|----------|----------|----------|
| 1    |          |          |          |
| 2    |          |          |          |
| 3    |          |          |          |
| 4    |          |          |          |
| 5    |          |          |          |
| 6    |          |          |          |

## 技术难点汇总

| 难点描述 | 解决方法 | 参考资料 |
|----------|----------|----------|
|          |          |          |
|          |          |          |
|          |          |          |